class Solution {

    Map<String, List<Character>> map = new HashMap<>();

    public boolean pyramidTransition(String bottom, List<String> allowed) {

        for (String s : allowed) {
            String key = s.substring(0, 2);
            char value = s.charAt(2);

            map.putIfAbsent(key, new ArrayList<>());
            map.get(key).add(value);
        }

        return canBuild(bottom);
    }

    private boolean canBuild(String current) {

        if (current.length() == 1) {
            return true;
        }

        List<String> nextLevels = new ArrayList<>();
        buildNext(current, 0, new StringBuilder(), nextLevels);

        for (String next : nextLevels) {
            if (canBuild(next)) {
                return true;
            }
        }

        return false;
    }

    private void buildNext(String current, int index, StringBuilder path, List<String> result) {

        if (index == current.length() - 1) {
            result.add(path.toString());
            return;
        }

        String key = current.substring(index, index + 2);

        if (!map.containsKey(key)) {
            return;
        }

        for (char c : map.get(key)) {
            path.append(c);
            buildNext(current, index + 1, path, result);
            path.deleteCharAt(path.length() - 1);
        }
    }
}
